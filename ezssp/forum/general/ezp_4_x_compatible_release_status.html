<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">



<!-- Mirrored from projects.ez.no/ezssp/forum/general/ezp_4_x_compatible_release_status by HTTrack Website Copier/3.x [XR&CO'2013], Wed, 08 Feb 2017 04:33:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>                                                                                
<title>
            ezp 4.x compatible release status?     /         General     /         Forum        
</title>

<meta http-equiv="Content-Language" content="en-GB" />
    <meta name="author" content="eZ Systems" />
    <meta name="copyright" content="eZ Systems" />
    <meta name="description" content="Content Management System" />
    <meta name="keywords" content="cms, publish, e-commerce, content management, development framework" />

<meta name="MSSmartTagsPreventParsing" content="TRUE" />
<meta name="generator" content="eZ Publish" />

<style type="text/css">
    @import url(../../../extension/ezprojects2007/design/ezprojects2007/stylesheets/core.css);
    @import url(../../../extension/ezprojects2007/design/ezprojects2007/stylesheets/pagelayout.css);
    @import url(../../../extension/ezprojects2007/design/ezprojects2007/stylesheets/classes.css);
    @import url(../../../extension/ezprojects2007/design/ezprojects2007/stylesheets/print.css) print;
</style>

<link type="text/css" rel="stylesheet" href="../../../extension/ezprojects2007/design/ezprojects2007/stylesheets/print.css" media="print" />

<!-- IE conditional comments; for bug fixes for different IE versions -->
<!--[if IE 5]>     <style type="text/css"> @import url(/extension/ezprojects2007/design/ezprojects2007/stylesheets/ie5.css);    </style> <![endif]-->
<!--[if lte IE 6]> <style type="text/css"> @import url(/extension/ezprojects2007/design/ezprojects2007/stylesheets/ie6lte.css); </style> <![endif]-->
<!--[if IE 6]>     <style type="text/css"> @import url(/extension/ezprojects2007/design/ezprojects2007/stylesheets/ie6.css);    </style> <![endif]-->

<!-- Load special stylesheet (if necessary) for newer Netscape decendants, Mozilla and Firefox, using the Gecko renderer -->
<script type="text/javascript"><!-- if ((navigator.userAgent.indexOf("Gecko") != -1)&&(navigator.userAgent.indexOf("KHTML") == -1)) document.write("<style type=\"text/css\">@import url(/extension/ezprojects2007/design/ezprojects2007/stylesheets/gecko.css);</style>");--></script>

<script type="text/javascript" src="../../../extension/ezprojects2007/design/ezprojects2007/javascripts/switch-width.js"></script>

<script type="text/javascript" src="../../../extension/ezprojects2007/design/ezprojects2007/javascripts/dropdownmenu.js"></script>
<script type="text/javascript" src="../../../extension/ezprojects2007/design/ezprojects2007/javascripts/insertmedia.js"></script>
<script type="text/javascript" src="../../../extension/ezprojects2007/design/ezprojects2007/javascripts/link-target.js"></script>

<script type="text/javascript" src="../../../var/plain_site/cache/public/javascript/059cd8e3b9fa455a526077cbccc48048.js" charset="utf-8"></script>


</head>
<body onload="menuInit();">

<!-- Complete page area: START -->
<div id="page">

<!-- Header area: START -->
<div id="header">
<div id="header-insert">

<!-- User menu area: START -->
<div id="usermenu">

<div id="page-width1">

<div id="logo">
<h1><a href="../../../index.html"><span class="hide">eZ Systems</span></a></h1>
</div>

<h2 id="slogan">Share your information</h2>

<p class="hide"><a href="#main">Skip to main content</a></p>

<hr class="hide" />
<div id="searchbox">
<form action="http://projects.ez.no/content/advancedsearch" method="get">

<div class="block">
<div class="element">
<input id="searchbutton" class="button" type="submit" value="Search" />
</div>

<div class="element searchstring">
    <label for="searchtext" class="hide">Search text:</label>
    <input id="searchtext" name="SearchText" type="text" size="12" />
    

    </div>

</div>
</form>
</div>

<hr class="hide" />
<h2 class="hide">User menu</h2>

<!-- User menu content: START -->
<ul>
            <li><a href="http://login.ez.no/register?return=http://projects.ez.no/ezpmemberreport">Become a member of the eZ Community</a></li>
        <li><a href="http://login.ez.no/forgotpassword?return=http://projects.ez.no/ezdbintegrity/news/ez_db_integrity_0_1_finally_available">Lost password?</a></li>
    
    <li>
    
    <script type="text/javascript">
    <!--
    if ( fixedSize )
    {
        document.write('<a id="setwidth" href="#" onclick="setWidth(); return false;">Dynamic width</a>');
    }
    else
    {
        document.write('<a id="setwidth" href="#" onclick="setWidth(); return false;">Fixed width</a>');
    }
    -->
    </script>
    
    </li>
    
            <li><a href="http://login.ez.no/login?return=http://projects.ez.no/">Log in</a></li>
    </ul>
<!-- User menu content: END -->

</div>

</div>
<!-- User menu area: END -->

</div>
</div>
<!-- Header area: END -->

                    
<script type="text/javascript">
<!--
var menu = new Array();

menu[0] = [];
menu[1] = [];
menu[2] = [];
menu[3] = [];
menu[4] = ['General', '/ezssp/forum/general'];
menu[5] = ['Leaders', '/ezssp/team/leaders', 'Members', '/ezssp/team/members'];
menu[6] = [];
menu[7] = [];

-->
</script>
<div id="menuborder">

<!-- Main menu area: START -->
<div id="menu" onmouseover="menuHover();" onmouseout="tryHideSubMenues();">

<div id="mainmenu" class="float-break">
<div id="page-width2">
    <ul id="mainmenulist" class="float-break">

    <li class="project" ><a href="../../../ezssp.html" onmouseover="switchSubMenu( this );">Subtree skeleton publisher &nbsp;&nbsp;&gt;&gt;</a></li>
                        <li ><a href="../../news.html" onmouseover="switchSubMenu( this );">News</a></li>
                            <li ><a href="../../reviews.html" onmouseover="switchSubMenu( this );">Reviews</a></li>
                            <li ><a href="../../downloads.html" onmouseover="switchSubMenu( this );">Downloads</a></li>
                            <li class="current"><a href="../../forum.html" onmouseover="switchSubMenu( this );">Forum</a></li>
                            <li ><a href="../../team.html" onmouseover="switchSubMenu( this );">Team</a></li>
                            <li ><a href="../../subversion.html" onmouseover="switchSubMenu( this );">Source</a></li>
                            <li class="last"><a href="../../gallery.html" onmouseover="switchSubMenu( this );">Gallery</a></li>
        
    </ul>

</div>
</div>


<div id="submenu">
<div id="page-width3">
    <ul class="float-break">

                    
            
    <li class="last current"><a href="../general.html">General</a></li>

        

</ul>
</div>
</div>

<script type="text/javascript"><!--
document.getElementById('submenu').style.display = 'none';
--></script>

</div>
<!-- Main menu area: END -->

</div>

<hr class="hide" />
<!-- Path area: START -->
<div id="path">

<div id="page-width4">
<h2 class="hide">Path</h2>

<!-- Path content: START -->
<p>
                                    <a href="../../../content/view/full/2.html">ez projects</a>
                    
                        /
                            <a href="../../../ezssp.html">ezssp</a>
        
                        /
                            <a href="../../forum.html">forum</a>
        
                        /
                            <a href="../general.html">general</a>
        
                        /
                                        ezp 4.x compatible release...
                    
            </p>
<!-- Path content: END -->

</div>

</div>
<!-- Path area: END -->

<hr class="hide" />

<!-- Main area: START -->

<div id="page-width5">
<div id="main" class="float-break">

<!-- Main area content: START -->




<div class="template-design area-main-full">
<div class="template-module content-view-full">
<div class="template-object class-forummessage">



<div id="top" class="attribute-heading">
    <h1>ezp 4.x compatible release status?</h1>
</div>


    <p>You need to be <a href="http://login.ez.no/login?return=http://projects.ez.no/">logged in</a> to post messages in the forums. New users may <a href="http://auth.ez.no/user/register">register here</a>.</p>


 



<div class="content-view-children">

<table class="forum list" cellspacing="0">

    




<tr class="bglight" id="msg13830">
    
    <td class="info">
        <p class="author"><a href="../../../users/community/norbert_wagner.html">Norbert Wagner</a></p>


                    <div class="attribute-image">

    
        
    
    <img src="../../../index.html" width="" height=""  border="0" alt="" title="" />
    
    
    </div>
        
        <p class="membersince">Member since:<br />09 January 2008</p>
        <p class="posts">Posts: 5</p>
    </td>

    
    <td class="message">
                    <form method="post" action="http://projects.ez.no/content/action">
                <div class="object-right">
                                                </div>
           </form>
       
        <p class="date">Thursday 29 January 2009 12:12:20 pm</p>

        <div class="attribute-long">Hi, <br />
what is the status of trunk, is it usable?<br />
Are there chances of a eZ Publish 4.x release soon?<br />
<br />
I would be very interested in this extension, perhaps I'll take a lunk at the trunk version.<br />
<br />
Thanks, <br />
Norbert
</div>
        
                                </td>
    <td class="buttons">
    <div class="button">
        <a href="#main"><img src="../../../extension/ezprojects2007/design/ezprojects2007/images/button-move_up.html" height="16" width="16" alt="Up" title="Jump to first message" /></a>
    </div>
    </td>
</tr>
    




<tr class="bgdark" id="msg13833">
    
    <td class="info">
        <p class="author"><a href="../../../users/community/kristof_coomans.html">Kristof Coomans</a></p>


                    <div class="attribute-image">

    
        
    
    <img src="../../../var/plain_site/storage/images/users/community/kristof_coomans/25898-18-eng-GB/kristof_coomans_small.html" width="100" height="100"  border="0" alt="" title="" />
    
    
    </div>
        
        <p class="membersince">Member since:<br />12 February 2004</p>
        <p class="posts">Posts: 68</p>
    </td>

    
    <td class="message">
                    <form method="post" action="http://projects.ez.no/content/action">
                <div class="object-right">
                                                </div>
           </form>
       
        <p class="date">Thursday 29 January 2009 1:09:42 pm</p>

        <div class="attribute-long">Hi Norbert<br />
<br />
Work on this extension is currently in the fridge, but you can use the trunk version for eZ Publish 4. If you discover any issues in it, then let us know. Good luck ;)
</div>
                    <div class="attribute-signature">
            <p>independent eZ Publish developer and service provider | <a href="http://blog.coomanskristof.be/" title="http://blog.coomanskristof.be">http://blog.coomanskristof.be</a> | <a href="http://ezpedia.org/" title="http://ezpedia.org">http://ezpedia.org</a></p>
            </div>
        
                                </td>
    <td class="buttons">
    <div class="button">
        <a href="#main"><img src="../../../extension/ezprojects2007/design/ezprojects2007/images/button-move_up.html" height="16" width="16" alt="Up" title="Jump to first message" /></a>
    </div>
    </td>
</tr>    




<tr class="bglight" id="msg13834">
    
    <td class="info">
        <p class="author"><a href="../../../users/community/norbert_wagner.html">Norbert Wagner</a></p>


                    <div class="attribute-image">

    
        
    
    <img src="../../../index.html" width="" height=""  border="0" alt="" title="" />
    
    
    </div>
        
        <p class="membersince">Member since:<br />09 January 2008</p>
        <p class="posts">Posts: 5</p>
    </td>

    
    <td class="message">
                    <form method="post" action="http://projects.ez.no/content/action">
                <div class="object-right">
                                                </div>
           </form>
       
        <p class="date">Thursday 29 January 2009 1:22:18 pm</p>

        <div class="attribute-long">Ok, I'll give it a try and let you know.<br />
<br />
Thanks,<br />
Norbert
</div>
        
                                </td>
    <td class="buttons">
    <div class="button">
        <a href="#main"><img src="../../../extension/ezprojects2007/design/ezprojects2007/images/button-move_up.html" height="16" width="16" alt="Up" title="Jump to first message" /></a>
    </div>
    </td>
</tr>    




<tr class="bgdark" id="msg20689">
    
    <td class="info">
        <p class="author"><a href="../../../users/community/sebastian_schoeller.html">Sebastian Schoeller</a></p>


                    <div class="attribute-image">

    
        
    
    <img src="../../../index.html" width="" height=""  border="0" alt="" title="" />
    
    
    </div>
        
        <p class="membersince">Member since:<br />07 March 2003</p>
        <p class="posts">Posts: 9</p>
    </td>

    
    <td class="message">
                    <form method="post" action="http://projects.ez.no/content/action">
                <div class="object-right">
                                                </div>
           </form>
       
        <p class="date">Tuesday 27 October 2009 8:17:22 am</p>

        <div class="attribute-long">Hi Norbert, hi Kristof,<br />
<br />
I think to have changed the code of ezssp in order to work with ez 4.2. I had changed some lines of code in <b>subtreeskeletonpublishtype.php</b> exclusively for the ezXML and ezDOMDocument objects, without knowing anything about eZ/php and it seems to work. Here it is:<br />
<br />
<pre class="wordwrap"><span class="line"></span>

<span class="line">&lt;?php</span>

<span class="line">//</span>

<span class="line">// ## BEGIN COPYRIGHT, LICENSE AND WARRANTY NOTICE ##</span>

<span class="line">// SOFTWARE NAME: eZ publish Subtree Skeleton Publisher extension</span>

<span class="line">// SOFTWARE RELEASE: 0.x</span>

<span class="line">// COPYRIGHT NOTICE: Copyright (C) 2007 Kristof Coomans &lt;<a href="http://blog.kristofcoomans.be>/" title="http://blog.kristofcoomans.be&gt;">http://blog.kristofcoomans.be&gt;</a></span>

<span class="line">// SOFTWARE LICENSE: GNU General Public License v2.0</span>

<span class="line">// NOTICE: &gt;</span>

<span class="line">//&nbsp;&nbsp;This program is free software; you can redistribute it and/or</span>

<span class="line">//&nbsp;&nbsp;modify it under the terms of version 2.0&nbsp;of the GNU General</span>

<span class="line">//&nbsp;&nbsp;Public License as published by the Free Software Foundation.</span>

<span class="line">//</span>

<span class="line">//&nbsp;&nbsp;This program is distributed in the hope that it will be useful,</span>

<span class="line">//&nbsp;&nbsp;but WITHOUT ANY WARRANTY; without even the implied warranty of</span>

<span class="line">//&nbsp;&nbsp;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&nbsp;See the</span>

<span class="line">//&nbsp;&nbsp;GNU General Public License for more details.</span>

<span class="line">//</span>

<span class="line">//&nbsp;&nbsp;You should have received a copy of version 2.0 of the GNU General</span>

<span class="line">//&nbsp;&nbsp;Public License along with this program; if not, write to the Free</span>

<span class="line">//&nbsp;&nbsp;Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,</span>

<span class="line">//&nbsp;&nbsp;MA 02110-1301, USA.</span>

<span class="line">//</span>

<span class="line">//</span>

<span class="line">// ## END COPYRIGHT, LICENSE AND WARRANTY NOTICE ##</span>

<span class="line">//</span>

<span class="line">&nbsp;</span>

<span class="line">class SubtreeSkeletonPublishType extends eZWorkflowEventType</span>

<span class="line">{</span>

<span class="line">&nbsp;&nbsp;&nbsp;var $oldNodeIDToNewObjectIDMap = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;var $ownerID;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function SubtreeSkeletonPublishType()</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;eZWorkflowEventType( 'subtreeskeletonpublish', ezi18n( 'extension/ezssp', 'Subtree Skeleton Publisher' ) );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// limit workflows which use this event to be used only on the post-publish trigger</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setTriggerTypes( array( 'content' =&gt; array( 'publish' =&gt; array( 'after' ) ) ) );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;oldNodeIDToNewObjectIDMap = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function attributeDecoder( $event, $attr )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retValue = null;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch( $attr )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'skeleton_node_id':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retValue = $event-&gt;attribute( 'data_int1' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'skeleton_user_groups':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retValue = $this-&gt;unserializeUserGroupsConfig( $event );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'role_list':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retValue = eZRole::fetchList();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeNotice( 'unknown attribute: ' . $attr, 'SubtreeSkeletonPublishType' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $retValue;</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function typeFunctionalAttributes()</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return array( 'skeleton_node_id', 'skeleton_user_groups', 'role_list' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function unserializeUserGroupsConfig( $event )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retValue = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xmlString = $event-&gt;attribute( 'data_text1' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $xmlString =='' )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $retValue;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dom = new DOMDocument();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dom-&gt;loadXML( $xmlString );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$root = $dom-&gt;documentElement;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$groups = $root-&gt;getElementsByTagName( 'group' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $groups as $group )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nodeID = $group-&gt;getAttribute( 'node_id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addOwner = ( $group-&gt;getAttribute( 'add_owner' ) !== false );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$roles = $group-&gt;getElementsByTagName( 'role' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$roleList = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $roles as $role )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$roleList[] = $role-&gt;getAttribute( 'role_id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retValue[$nodeID] = array( 'roles' =&gt; $roleList, 'add_owner' =&gt; $addOwner );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $retValue;</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function serializeUserGroupsConfig( $userGroups )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dom = new DOMDocument();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$skeleton = $dom-&gt;createElement( 'skeleton' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dom-&gt;appendChild( $skeleton );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $userGroups as $nodeID =&gt; $groupConfig )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset( $groupNode );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$groupNode = $dom-&gt;createElement( 'group' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$groupNode-&gt;setAttribute( 'node_id', $nodeID );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$skeleton-&gt;appendChild( $groupNode );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $groupConfig['add_owner'] == true )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$groupNode-&gt;setAttribute( 'add_owner', 'true' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( array_key_exists( 'roles', $groupConfig ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $groupConfig['roles'] as $roleID )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset( $roleNode );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$roleNode = $dom-&gt;createElement( 'role' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$roleNode-&gt;setAttribute( 'role_id', $roleID );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$groupNode-&gt;appendChild( $roleNode );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xmlString = $dom-&gt;saveXML();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $xmlString;</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function fetchHTTPInput( $http, $base, $event )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups = $this-&gt;attributeDecoder( $event, 'skeleton_user_groups' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this condition can be removed when this issue if fixed: <a href="http://issues.ez.no/10685" title="http://issues.ez.no/10685">http://issues.ez.no/10685</a></span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( count( $_POST ) &gt; 0 )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups = $this-&gt;attributeDecoder( $event, 'skeleton_user_groups' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroupRoles = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rolesPostVarName = 'UserGroupRoleList_' . $event-&gt;attribute( 'id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $http-&gt;hasPostVariable( $rolesPostVarName ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroupRoles = $http-&gt;postVariable( $rolesPostVarName );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addOwnerGroups = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addOwnerPostVarName = 'UserGroupAddOwner_' . $event-&gt;attribute( 'id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $http-&gt;hasPostVariable( $addOwnerPostVarName ) &amp;&amp; is_array( $http-&gt;postVariable( $addOwnerPostVarName ) ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addOwnerGroups = $http-&gt;postVariable( $addOwnerPostVarName );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $userGroups as $groupID =&gt; $groupConfig )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( array_key_exists( $groupID, $userGroupRoles ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups[$groupID]['roles'] = $userGroupRoles[$groupID];</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups[$groupID]['roles'] = array();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups[$groupID]['add_owner'] = in_array( $groupID, $addOwnerGroups );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$serializedUserGroupsConfig = $this-&gt;serializeUserGroupsConfig( $userGroups );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeDebug( $serializedUserGroupsConfig, 'fetchHTTPInput' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event-&gt;setAttribute( 'data_text1', $serializedUserGroupsConfig );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;/*!</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;\reimp</span>

<span class="line">&nbsp;&nbsp;&nbsp;*/</span>

<span class="line">&nbsp;&nbsp;&nbsp;function customWorkflowEventHTTPAction( $http, $action, $workflowEvent )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eventID = $workflowEvent-&gt;attribute( 'id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$module = $GLOBALS['eZRequestedModule'];</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch ( $action )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'SelectSkeleton':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZContentBrowse::browse( array( 'action_name' =&gt; 'SelectSkeleton',</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'browse_custom_action' =&gt; array( 'name' =&gt; 'CustomActionButton[' . $eventID . '_SkeletonSelected]',</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'value' =&gt; $eventID ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'from_page' =&gt; '/workflow/edit/' . $workflowEvent-&gt;attribute( 'workflow_id' ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'ignore_nodes_select' =&gt; $this-&gt;attributeDecoder( $workflowEvent, 'skeleton_node_id' )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$module );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'SkeletonSelected':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nodeList = eZContentBrowse::result( 'SelectSkeleton' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $nodeList )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$workflowEvent-&gt;setAttribute( 'data_int1', $nodeList[0] );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'AddSkeletonUserGroups':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZContentBrowse::browse( array( 'action_name' =&gt; 'AddSkeletonUserGroups',</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'browse_custom_action' =&gt; array( 'name' =&gt; 'CustomActionButton[' . $eventID . '_SkeletonUserGroupsAdded]',</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'value' =&gt; $eventID ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'start_node' =&gt; $this-&gt;attributeDecoder( $workflowEvent, 'skeleton_node_id' ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'from_page' =&gt; '/workflow/edit/' . $workflowEvent-&gt;attribute( 'workflow_id' ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'ignore_nodes_select' =&gt; array_keys( $this-&gt;attributeDecoder( $workflowEvent, 'skeleton_user_groups' ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$module );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'SkeletonUserGroupsAdded':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nodeList = eZContentBrowse::result( 'AddSkeletonUserGroups' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $nodeList )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;addUserGroups( $workflowEvent, $nodeList );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 'RemoveSkeletonUserGroups':</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$removeVarName = 'DeleteUserGroupIDList_' . $eventID;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $http-&gt;hasPostVariable( $removeVarName ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$removeList = $http-&gt;postVariable( $removeVarName );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;removeUserGroups( $workflowEvent, $removeList );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} break;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeNotice( 'unknown custom action: ' . $action, 'SubtreeSkeletonPublishType' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;/*!</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;\brief Adds user groups to the list</span>

<span class="line">&nbsp;&nbsp;&nbsp;*/</span>

<span class="line">&nbsp;&nbsp;&nbsp;function addUserGroups( $workflowEvent, $nodeList )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups = $this-&gt;attributeDecoder( $workflowEvent, 'skeleton_user_groups' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $nodeList as $nodeID )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( !array_key_exists( $nodeID, $userGroups ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups[$nodeID] = array( 'roles' =&gt; array(), 'add_owner' =&gt; false );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$serializedUserGroupsConfig = $this-&gt;serializeUserGroupsConfig( $userGroups );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeDebug( $serializedUserGroupsConfig, 'addUserGroups' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$workflowEvent-&gt;setAttribute( 'data_text1', $serializedUserGroupsConfig );</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function removeUserGroups( $workflowEvent, $nodeList )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups = $this-&gt;attributeDecoder( $workflowEvent, 'skeleton_user_groups' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $nodeList as $nodeID )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( array_key_exists( $nodeID, $userGroups ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset( $userGroups[$nodeID] );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$serializedUserGroupsConfig = $this-&gt;serializeUserGroupsConfig( $userGroups );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeDebug( $serializedUserGroupsConfig, 'removeUserGroups' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$workflowEvent-&gt;setAttribute( 'data_text1', $serializedUserGroupsConfig );</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function execute( $process, $event )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// global variable to prevent endless recursive workflows with this event</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$recursionProtect = 'SubTreeSkelectonPublishType_recursionprotect_' . $event-&gt;attribute( 'id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( array_key_exists( $recursionProtect, $GLOBALS ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return eZWorkflowType::STATUS_ACCEPTED;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parameters = $process-&gt;attribute( 'parameter_list' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$object = eZContentObject::fetch( $parameters['object_id'] );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if the object is not published for the first time, then we don't do anything</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $object-&gt;attribute( 'modified' ) != $object-&gt;attribute( 'published' ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return eZWorkflowType::STATUS_ACCEPTED;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// put the following block in comments for easy debugging</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// defer to cron, this is safer because we are going to create some other objects as well</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( eZSys::isShellExecution() == false )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return eZWorkflowType::STATUS_DEFERRED_TO_CRON_REPEAT;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( !array_key_exists( $recursionProtect, $GLOBALS ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$GLOBALS[$recursionProtect] = true;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;copySkeleton( $object, $event );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;addOwnerLocation( $object, $event );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assignRoles( $object, $event );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset( $GLOBALS[$recursionProtect] );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return eZWorkflowType::STATUS_ACCEPTED;</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function addOwnerLocation( $object, $event )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups = $this-&gt;attributeDecoder( $event, 'skeleton_user_groups' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userID = $object-&gt;attribute( 'owner_id' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $userGroups as $groupNodeID =&gt; $groupConfig )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $groupConfig['add_owner'] == true )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( !array_key_exists( $groupNodeID, $this-&gt;oldNodeIDToNewObjectIDMap ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// show debug warning</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newGroupID = $this-&gt;oldNodeIDToNewObjectIDMap[$groupNodeID];</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$operationResult = eZOperationHandler::execute( 'membership', 'register', array( 'group_id' =&gt; $newGroupID, 'user_id' =&gt; $userID ) );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function assignRoles( $object, $event )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$madeChanges = array();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = eZDB::instance();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;begin();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userGroups = $this-&gt;attributeDecoder( $event, 'skeleton_user_groups' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $userGroups as $groupNodeID =&gt; $groupConfig )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use the node id of the copied node</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( !array_key_exists( $groupNodeID, $this-&gt;oldNodeIDToNewObjectIDMap ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// show debug warning</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newGroupID = $this-&gt;oldNodeIDToNewObjectIDMap[$groupNodeID];</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $groupConfig['roles'] as $roleID )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$role = eZRole::fetch( $roleID );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( !is_object( $role ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// show debug warning</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$projectNode = $object-&gt;attribute( 'main_node' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pathString = $projectNode-&gt;attribute( 'path_string' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query = &quot;INSERT INTO ezuser_role ( role_id, contentobject_id, limit_identifier, limit_value ) VALUES ( '$roleID', '$newGroupID', 'Subtree', '$pathString' )&quot;;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;query( $query );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;commit();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( in_array( true, $madeChanges ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZRole::expireCache();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZContentCacheManager::clearAllContentCache();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZUser::cleanupCache();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;/*</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PART: SKELETON</span>

<span class="line">&nbsp;&nbsp;&nbsp;*/</span>

<span class="line">&nbsp;&nbsp;&nbsp;function copySkeleton( $object, $event )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$projectNode = $object-&gt;attribute( 'main_node' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;ownerID = $object-&gt;attribute( 'owner_id' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$skeletonNodeID = $this-&gt;attributeDecoder( $event, 'skeleton_node_id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$skeletonNode = eZContentObjectTreeNode::fetch( $skeletonNodeID );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;copyChildrenRecursive( $skeletonNode, $projectNode );</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;/*</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maybe we need to use this first parameter, to ignore policies</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;But I don't think it does any harm that each user can read the skeleton</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array( 'Limitation' =&gt; array() )</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maybe it's useful to not read every node because of permissions of the project creator</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then we can insert customer groups and other stuff too in the skeleton</span>

<span class="line">&nbsp;&nbsp;&nbsp;*/</span>

<span class="line">&nbsp;&nbsp;&nbsp;function copyChildrenRecursive( $sourceParentNode, $targetParentNode )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = eZDB::instance();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;begin();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sourceParentNodeID = $sourceParentNode-&gt;attribute( 'node_id' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$timeSortFields = array( 'published', 'modified', 'modified_subnode' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sortOrder = $sourceParentNode-&gt;attribute( 'sort_order' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sortField = $sourceParentNode-&gt;attribute( 'sort_field' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$delay = false;</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( in_array( eZContentObjectTreeNode::sortFieldName( $sortField ), $timeSortFields ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// bitwise NOT</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sortOrder = ~ $sortOrder;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$delay = true;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sortArray = eZContentObjectTreeNode::sortArrayBySortFieldAndSortOrder( $sourceParentNode-&gt;attribute( 'sort_field' ), $sortOrder );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$subTreeParams = array(</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Depth' =&gt; 1,</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'DepthOperator' =&gt; 'eq',</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Limitation' =&gt; array(),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'SortBy' =&gt; $sortArray</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sourceNodeList = eZContentObjectTreeNode::subTreeByNodeID( $subTreeParams, $sourceParentNodeID );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( $sourceNodeList as $sourceNode )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeDebug( $sourceNode-&gt;attribute( 'name' ) );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNode = $this-&gt;copyNode( $sourceNode, $targetParentNode, $sourceParentNode );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;oldNodeIDToNewObjectIDMap[$sourceNode-&gt;attribute( 'node_id' )] = $newNode-&gt;attribute( 'contentobject_id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sourceObj = $sourceParentNode-&gt;object();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$contentClass = $sourceObj-&gt;attribute( 'content_class' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $contentClass-&gt;attribute( 'is_container' ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;copyChildrenRecursive( $sourceNode, $newNode );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $delay )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZDebug::writeDebug( 'found timed-sorted subtree, sleeping 2 seconds' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep( 2 );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;commit();</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;function copyNode( $sourceNode, $targetParentNode, $sourceParentNode )</span>

<span class="line">&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sourceParentObject = $sourceParentNode-&gt;attribute( 'object' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tagetParentObject = $targetParentNode-&gt;attribute( 'object' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$object = $sourceNode-&gt;attribute( 'object' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sectionID = $tagetParentObject-&gt;attribute( 'section_id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $object-&gt;attribute( 'section_id' ) != $sourceParentObject-&gt;attribute( 'section_id' ) )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sectionID = $object-&gt;attribute( 'section_id' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//eZDebug::writeDebug( 'section id: ' . $sectionID );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newObject = $object-&gt;copy( false );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newObject-&gt;setAttribute( 'section_id', $sectionID );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newObject-&gt;setAttribute( 'owner_id', $this-&gt;ownerID );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newObject-&gt;store();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newParentNodeID = $targetParentNode-&gt;attribute( 'node_id' );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$curVersion&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $newObject-&gt;attribute( 'current_version' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$curVersionObject&nbsp;= $newObject-&gt;attribute( 'current' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$curVersionObject-&gt;setAttribute( 'creator_id', $this-&gt;ownerID );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$curVersionObject-&gt;store();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newObjAssignments = $curVersionObject-&gt;attribute( 'node_assignments' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset( $curVersionObject );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// remove old node assignments</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach( $newObjAssignments as $assignment )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$assignment-&gt;remove();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// and create a new one</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nodeAssignment = eZNodeAssignment::create( array(</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'contentobject_id' =&gt; $newObject-&gt;attribute( 'id' ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'contentobject_version' =&gt; $curVersion,</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'parent_node' =&gt; $newParentNodeID,</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'is_main' =&gt; 1,</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'sort_field' =&gt; $sourceNode-&gt;attribute( 'sort_field' ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'sort_order' =&gt; $sourceNode-&gt;attribute( 'sort_order' )</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nodeAssignment-&gt;store();</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result = eZOperationHandler::execute( 'content', 'publish',</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array( 'object_id' =&gt; $newObject-&gt;attribute( 'id' ),</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'version'&nbsp;&nbsp;=&gt; $curVersion ) );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Update &quot;priority&quot; and &quot;is_invisible&quot; attribute for the newly created node.</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNode = $newObject-&gt;attribute( 'main_node' );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNode-&gt;setAttribute( 'priority', $sourceNode-&gt;attribute( 'priority' ) );</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNode-&gt;store();</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eZContentObjectTreeNode::updateNodeVisibility( $newNode, $targetParentNode );</span>

<span class="line">&nbsp;</span>

<span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $newNode;</span>

<span class="line">&nbsp;&nbsp;&nbsp;}</span>

<span class="line">}</span>

<span class="line">&nbsp;</span>

<span class="line">eZWorkflowEventType::registerEventType( 'subtreeskeletonpublish', 'SubtreeSkeletonPublishType' );</span>

<span class="line">&nbsp;</span>

<span class="line">?&gt;</span>

<span class="line"></span></pre>
</div>
        
                                </td>
    <td class="buttons">
    <div class="button">
        <a href="#main"><img src="../../../extension/ezprojects2007/design/ezprojects2007/images/button-move_up.html" height="16" width="16" alt="Up" title="Jump to first message" /></a>
    </div>
    </td>
</tr>
</table>

</div>



 

            <p>You need to be <a href="http://login.ez.no/login?return=http://projects.ez.no/">logged in</a> to post messages in the forums. New users may <a href="http://auth.ez.no/user/register">register here</a>.</p>
    
</div>
</div>
</div>



<!-- Main area content: END -->

</div>
</div>
<!-- Main area: END -->
<hr class="hide" />

<!-- Footer area: START -->
<div id="page-width6">
<div id="footer">

<address>Powered by <a href="http://ez.no/ezpublish" title="eZ Publish Content Management System">eZ Publish&reg; Content Management System.</a></address>
<address>Copyright &copy; 2007-2011 eZ Systems AS (except where otherwise noted). All rights reserved.</address>
</div>
</div>
<!-- Footer area: END -->

</div>
<!-- Complete page area: END -->

<!-- BEGIN GA tracker script -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24601020-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- END GA tracker script -->





</body>

<!-- Mirrored from projects.ez.no/ezssp/forum/general/ezp_4_x_compatible_release_status by HTTrack Website Copier/3.x [XR&CO'2013], Wed, 08 Feb 2017 04:33:37 GMT -->
</html>
